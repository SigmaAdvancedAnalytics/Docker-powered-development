FROM base-image
MAINTAINER Joshua Barber "j.barber501@gmail.com"

USER root

ENV PROD_USER jeb
ENV NB_UID 1000
ENV HOME /home
ENV ENV_NAME docker-env
ENV STARTSCRIPT /home/start.sh
ENV APP_ACTIVATE "jupyter notebook"

# Create jeb user
RUN useradd -m -s /bin/bash -N -u $NB_UID $PROD_USER && \
    mkdir -p $CONDA_DIR && \
    chown $PROD_USER $CONDA_DIR

# Setup jeb home directory
RUN mkdir /home/config && \
    mkdir /home/config/.jupyter && \
    echo "cacert=/etc/ssl/certs/ca-certificates.crt" > /home/config/.curlrc

# Miniconda installation
RUN cd /tmp && \
    mkdir -p $CONDA_DIR && \
    wget --quiet https://repo.continuum.io/miniconda/Miniconda3-4.2.12-Linux-x86_64.sh && \
    /bin/bash Miniconda3-4.2.12-Linux-x86_64.sh -f -b -p $CONDA_DIR && \
    rm Miniconda3-4.2.12-Linux-x86_64.sh && \
    $CONDA_DIR/bin/conda config --system --add channels conda-forge && \
    $CONDA_DIR/bin/conda config --system --set auto_update_conda false && \
    conda clean -tipsy
 
# Install spark
RUN cd /home && \
    wget --quiet https://archive.apache.org/dist/spark/spark-2.2.0/pyspark-2.2.0.tar.gz && \
    tar -xvf pyspark-2.2.0.tar.gz && \
    rm pyspark-2.2.0.tar.gz

# Install SBT
RUN cd /home && \
    wget --quiet https://github.com/sbt/sbt/releases/download/v0.13.15/sbt-0.13.15.tgz && \
    tar -xvf sbt-0.13.15.tgz && \
    rm sbt-0.13.15.tgz && \
    cd /home/pyspark-2.2.0 && \
    /home/sbt/bin/sbt

# Install Jupyter Notebook and Hub
RUN conda install -c conda-forge --quiet --yes \
    'notebook=4.3*' \
    'jupyterhub=0.7.2' \
    && conda clean -tipsy
 
# Upgrade pip
RUN pip install --upgrade pip

WORKDIR /home
    
# Install Python 3 packages
RUN chown -R $PROD_USER:users /home
COPY dev-requirements.yml jupyter_config.py ./
RUN conda env create -f dev-requirements.yml -n $ENV_NAME

# Script: Activate conda env and launch application
RUN echo "#!/bin/bash" >> $STARTSCRIPT && \
	echo "source activate $ENV_NAME" >> $STARTSCRIPT && \
	echo "$APP_ACTIVATE" >> $STARTSCRIPT && \
	chmod +x $STARTSCRIPT

# Configure container startup
ENTRYPOINT ["/usr/local/bin/tini", "--"]
CMD ["/bin/sh","start.sh"]

USER $PROD_USER


